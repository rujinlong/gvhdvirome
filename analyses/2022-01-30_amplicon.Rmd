---
title: "R Notebook"
output: html_notebook
---

```{r}
library(here)
library(tidyverse)
# library(phyloseq)
library(speedyseq)
library(readxl)

load(here("data/processed/physeq_16s.Rdata"))
mdata <- read_excel(here("data/processed/metadata_amp.xlsx"))

physeq@sam_data <- physeq@sam_data %>% 
  data.frame() %>% 
  rownames_to_column("rowname") %>% 
  left_join(mdata, by = "samplename") %>% 
  column_to_rownames("rowname") %>% 
  sample_data()

# Filter samples
sample_order <- c("COND", "0", "7", "14", "21", "28", "POST")
physeq <- subset_samples(physeq, Timepoint %in% sample_order)

# save(physeq, file = here("data/physeq_16s_filter.RData"))
```

```{r Alpha-diversity}
p <- physeq %>% 
  plot_richness(x="Timepoint", measures = c("Chao1", "Shannon")) +
    stat_boxplot(geom = "errorbar",width = 0.35) +
    geom_boxplot() +
    theme_bw()

p$data$Timepoint <- factor(p$data$Timepoint, levels = sample_order)
ggsave(here("figs/16s_alpha-diversity.pdf"), p)
print(p)
```


```{r Taxonomy}
sdata <- sample_data(physeq)
ps0 <- merge_samples2(physeq, group = sdata$Timepoint)

ps_phylum <- ps0 %>%
  tax_glom(taxrank = "Phylum") %>%                 # agglomerate at Phylum level, (Order, Family, ...)
  transform_sample_counts(function(x) {x/sum(x)} ) %>% 
  psmelt() %>% 
  arrange(Phylum)

p <- ps_phylum %>% 
  filter(Abundance>0.001) %>%
  ggplot(aes(x = Timepoint, y = Abundance, fill = Phylum)) +    # Color by Phylum
  geom_bar(stat = "identity", position="stack") +
  guides(fill = guide_legend(reverse = TRUE, keywidth = 1, keyheight = 1)) +
  ylab("Relative Abundance (> 0.1%) \n") +
  theme_bw()

p$data$Timepoint <- factor(p$data$Timepoint, levels = sample_order)
ggsave(here("figs/16s_taxonomy_relative_abundance.pdf"), p)
print(p)
```


```{r Ordination}
pseq_ord <- ordinate(physeq, "PCoA", "bray")
# pseq_ord <- ordinate(physeq, "MDS", "unifrac")
p <- plot_ordination(physeq, pseq_ord, type="samples", color="Timepoint") +
  geom_point(size=1, alpha=0.3) + 
  stat_ellipse(aes(fill = Timepoint), geom="polygon",level=0.95,alpha=0.1) +
  theme_bw()

ggsave(here("figs/16s_ordination.pdf"), p)
print(p)
```


